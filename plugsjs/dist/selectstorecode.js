!function(a){var b="selectStoreCode",c={host:"",arr:[],backdatainfo:function(){}},d=function(b,d){this.$ele=a(b),this.options=a.extend({},c,d),this.init()};d.prototype={initDom:function(){return this.$getstoreurl=this.options.host+"/index.php/shangjia/softstore/stores",this.$getstaffurl=this.options.host+"/index.php/shangjia/commoncomponent/getstaffaccount?page_size=0",this.$getcodeurl=this.options.host+"/index.php/shangjia/scanqrcodepay/qrcodelist?page_size=0",this.$listdata_obj="",this.$listdata_arr=[],this},init:function(){return this.initDom().create().initdata(),this},create:function(){var b=this,c=[];c[0]='<div id="myStoreCodeModal" class="modal hide fade" data-width="700"><div class="modal-header"><button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button><h3>管理门店二维码</h3></div><div class="modal-body"><div class="pdatas datalist"><div class="scrollbar datacontent"></div><div class="storepage"></div></div><div class="viewdatas datalist"><div class="datatitle">已选择：</div><div class="scrollbar datacontent"></div></div></div><div class="modal-footer"><button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button><button class="btn btn-primary savebtn">确定</button></div></div>';var d=a("body").find("#myStoreCodeModal").length;return 0>=d&&a(document.body).append(c[0]),b.$modalHTML=a("body").find("#myStoreCodeModal"),b.$storebox=b.$modalHTML.find(".pdatas .datacontent"),b.$storepage=b.$modalHTML.find(".pdatas .storepage"),b.$pagebtn=b.$modalHTML.find(".storepage span a"),b.$viewbox=b.$modalHTML.find(".viewdatas .datacontent"),b.$confirmbtn=b.$modalHTML.find(".savebtn"),this},initdata:function(){return this.editarr(),this.getstorelist(1),this.ajaxpagestorelist(),this},editarr:function(){var a=this,b=a.options.arr;b.length>0&&(a.$listdata_arr=b,a.previewdata(a.$listdata_arr))},getstorelist:function(b){var c=this;a.ajax({type:"POST",url:c.$getstoreurl,data:{page:b},dataType:"json",success:function(d){if(0==d.total)c.$storebox.html("<div class='datawarn'>没有数据</div>"),c.$storepage.hide();else{d.pages>1&&(c.$storepage.show(),c.$total=d.total,c.$totalPage=d.pages,c.$curPage=b);var e=d.list,f="";if(e.map(function(a){return f+='<li class="p_item" data-pcode="'+a.id+'" data-pname="'+a.name+'"><div class="item_title" title="门店"><span class="showlist j_store" data-pcode="'+a.id+'"><i class="ywkicon icon-caretright"></i></span><label><input type="checkbox" name="province_'+a.id+'" class="p_check checkcode" data-pcode="'+a.id+'" data-pname="'+a.name+'"/>'+a.name+'<code>门店</code></label></div><ul class="staff_box" data-pcode="'+a.id+'"></ul></li>'}),c.$storebox.html('<ul class="store_box">'+f+"</ul>"),c.$listdata_arr&&c.$listdata_arr.length>0)for(var g=0;g<c.$listdata_arr.length;g++){var h=c.$listdata_arr[g].pcode,i=c.$listdata_arr[g].ccode;c.$listdata_arr[g].code;c.$storebox.find(".p_item").each(function(){var b=a(this).attr("data-pcode");h==b&&(""==i?a(this).find(".p_check").attr("checked",!0):a(this).find(".p_check").addClass("hasdata"))})}}},complete:function(){if(c.$totalPage>1){var b=a.getPageBar(c.$curPage,c.$totalPage,c.$total);c.$storepage.html(b)}},error:function(){c.$storebox.html("<div class='datawarn'>数据加载失败</div>"),c.$storepage.hide()}})},ajaxpagestorelist:function(){var b=this;b.$pagebtn.live("click",function(){var c=a(this).attr("rel");c&&b.getstorelist(c)})},getstafflist:function(b,c){var d=this,e=a(".p_check[data-pcode='"+b+"']").is(":checked");a.ajax({type:"POST",url:d.$getstaffurl,data:{storeid:b},dataType:"json",success:function(f){if(0==f.count);else{var g=f.offline,h="";g.map(function(a){return h+='<li class="c_item"  data-ccode="'+a.id+'" data-cname="'+a.service_name+'"><div class="item_title" title="员工"><span class="showlist j_staff" data-pcode="'+b+'"  data-ccode="'+a.id+'"><i class="ywkicon icon-caretright"></i></span><label><input type="checkbox" name="city_'+a.id+'" class="c_check checkcode" '+(e?"checked":"")+' data-pcode="'+b+'"  data-ccode="'+a.id+'" data-pname="'+c+'" data-cname="'+a.service_name+'"/>'+a.service_name+'<code>员工</code></label></div><ul class="code_box" data-ccode="'+a.id+'"></ul></li>'});var i=d.$storebox.find(".p_item[data-pcode='"+b+"']").find(".staff_box");if(i.html(h),d.$listdata_arr&&d.$listdata_arr.length>0)for(var j=0;j<d.$listdata_arr.length;j++){var k=(d.$listdata_arr[j].pcode,d.$listdata_arr[j].ccode),l=d.$listdata_arr[j].code;d.$storebox.find(".p_item[data-pcode='"+b+"']").find(".c_item").each(function(){var b=a(this).attr("data-ccode");k==b&&(""==l?a(this).find(".c_check").attr("checked",!0):a(this).find(".c_check").addClass("hasdata"))})}}}})},getcodelist:function(b,c){var d=this,e=a(".c_check[data-ccode='"+c+"']").is(":checked")?!0:!1;a.ajax({type:"POST",url:d.$getcodeurl,data:{store_id:b,service_id:c},dataType:"json",success:function(f){if(0==f.total);else{var g=f.list,h="";g.map(function(a){return h+='<li class="a_item" data-code="'+a.qrc_id+'" data-name="'+a.qrc_name+'"><div class="area_title item_title" title="收款码"><label><input type="checkbox" name="area_'+a.qrc_id+'" class="a_check checkcode"  '+(e?"checked":"")+' data-pcode="'+b+'"  data-ccode="'+c+'" data-code="'+a.qrc_id+'" data-name="'+a.qrc_name+'"/>'+a.qrc_name+"<code>收款码</code></label></div></li>"});var i=d.$storebox.find(".p_item[data-pcode='"+b+"']").find(".c_item[data-ccode='"+c+"']").find(".code_box");if(i.html(h),d.$listdata_arr&&d.$listdata_arr.length>0)for(var j=0;j<d.$listdata_arr.length;j++){var k=(d.$listdata_arr[j].pcode,d.$listdata_arr[j].ccode,d.$listdata_arr[j].code),l=d.$storebox.find(".p_item[data-pcode='"+b+"']").find(".c_item[data-ccode='"+c+"']").find(".code_box");l.find(".a_item").each(function(){var b=a(this).attr("data-code");k==b&&a(this).find(".a_check").attr("checked",!0)})}}}})},getcitycheck:function(b){var c=a(".c_check[data-pcode='"+b+"']").length,d=a(".c_check[data-pcode='"+b+"']:checked").length;return c==d?1:c==parseInt(d)+1?2:3},getareacheck:function(b){var c=a(".a_check[data-ccode='"+b+"']").length,d=a(".a_check[data-ccode='"+b+"']:checked").length;return c==d?1:c==parseInt(d)+1?2:3},insertstore:function(a){for(var b=this,c=[],d=b.$storebox.find(".p_item[data-pcode='"+a+"']").attr("data-pname"),e={pcode:a,ccode:"",code:"",name:d},f=0;f<b.$listdata_arr.length;f++)a!==b.$listdata_arr[f].pcode&&c.push(b.$listdata_arr[f]);return c.push(e),c},insertcity:function(a){for(var b=this,c=[],d=0;d<b.$listdata_arr.length;d++)a!==b.$listdata_arr[d].ccode&&c.push(b.$listdata_arr[d]);return c},operate_p_data:function(b,c,d,e,f){var g=this;if(1==f){var h=g.insertstore(b);g.$listdata_arr=[],g.$listdata_arr=h}else 2==f&&a.removeItem(g.$listdata_arr,b,"pcode")},operate_c_data:function(b,c,d,e,f){var g=this;if(1==f)if(g.$listdata_obj={pcode:b,ccode:c,code:d,name:e},1==g.getcitycheck(b))g.operate_p_data(b,c,d,e,f);else{var h=g.insertcity(c);g.$listdata_arr=[],g.$listdata_arr=h,g.$listdata_arr.push(g.$listdata_obj)}else if(2==f)if(2==g.getcitycheck(b)){a.removeItem(g.$listdata_arr,b,"pcode");var i=g.$storebox.find(".staff_box[data-pcode='"+b+"']");i.find(".c_item").each(function(){var d=a(this).attr("data-cname"),e=a(this).attr("data-ccode");if(c!==e){var f={pcode:b,ccode:e,code:"",name:d};g.$listdata_arr.push(f)}})}else a.removeItem(g.$listdata_arr,c,"ccode")},operate_a_data:function(b,c,d,e,f){var g=this;if(1==f)if(1==g.getareacheck(c))if(1==g.getcitycheck(b))g.operate_p_data(b,c,d,e,f);else{var h=g.insertcity(c);g.$listdata_arr=[],g.$listdata_arr=h;var i=g.$storebox.find(".c_item[data-ccode='"+c+"']").attr("data-cname");g.$listdata_obj={pcode:b,ccode:c,code:"",name:i},g.$listdata_arr.push(g.$listdata_obj)}else g.$listdata_obj={pcode:b,ccode:c,code:d,name:e},g.$listdata_arr.push(g.$listdata_obj);else if(2==f)if(2==g.getareacheck(c)){g.operate_c_data(b,c,d,e,f),a.removeItem(g.$listdata_arr,c,"ccode");var j=g.$storebox.find(".code_box[data-ccode='"+c+"']"),h=[];j.find(".a_item").each(function(){var e=a(this).attr("data-name"),f=a(this).attr("data-code");if(d!==f){var h={pcode:b,ccode:c,code:f,name:e};g.$listdata_arr.push(h)}})}else a.removeItem(g.$listdata_arr,d,"code")},previewdata:function(a){var b=this,c="";for(var d in a){var e=a[d].name,f=a[d].pcode,g=a[d].ccode,h=a[d].code,i="";i=""!==f&&""!==g&&""!==h?"<code>收款码</code>":""!==f&&""!==g?"<code>员工</code>":"<code>门店</code>",c+='<span class="a_item j_preview active" data-pcode="'+f+'" data-ccode="'+g+'" data-code="'+h+'" >'+e+i+"</span>"}b.$viewbox.html(c)},show:function(){return this.$modalHTML.modal("show"),this},hide:function(){return this.$modalHTML.modal("hide"),this},bindEvent:function(){var b=this,c=b.$ele,d=b.$storebox.find(".j_store"),e=b.$storebox.find(".j_staff"),f=b.$storebox.find(".p_check"),g=b.$storebox.find(".c_check"),h=b.$storebox.find(".a_check");d.die(),d.live("click",function(){var c=a(this).attr("data-pcode"),d=a(this).attr("data-pname");a(this).toggleClass("active"),a(this).parents(".p_item").toggleClass("active");var e=a(this).parents(".p_item").find(".staff_box");e.find(".c_item").length<=0&&a(this).hasClass("active")&&b.getstafflist(c,d)}),e.die(),e.live("click",function(){var c=a(this).attr("data-pcode"),d=a(this).attr("data-ccode");a(this).toggleClass("active"),a(this).parents(".c_item").toggleClass("active");var e=a(this).parents(".c_item").find(".code_box");e.find(".a_item").length<=0&&a(this).hasClass("active")&&b.getcodelist(c,d)}),f.die(),f.live("change",function(){var c=a(this).attr("data-pcode"),d=a(this),e=a(this).attr("data-pname");d.is(":checked")?(a(".c_check[data-pcode='"+c+"']").attr("checked",!0),b.operate_p_data(c,"","",e,1)):(a(".c_check[data-pcode='"+c+"']").attr("checked",!1),d.removeClass("hasdata"),b.operate_p_data(c,"","",e,2)),b.previewdata(b.$listdata_arr),a(".c_check[data-pcode='"+c+"']").trigger("change")}),g.die(),g.live("change",function(){var c=a(this),d=a(this).attr("data-ccode"),e=a(this).attr("data-pcode"),f=a(this).attr("data-cname"),g=a(".c_check[data-pcode='"+e+"']:checked").length;a(".p_check[data-pcode='"+e+"']").attr("checked",1==b.getcitycheck(e)?!0:!1),c.is(":checked")?(a(".a_check[data-ccode='"+d+"']").attr("checked",!0),b.operate_c_data(e,d,"",f,1)):(a(".a_check[data-ccode='"+d+"']").attr("checked",!1),c.removeClass("hasdata"),b.operate_c_data(e,d,"",f,2));var h=a(".c_check.hasdata[data-pcode='"+e+"']").length;g>0||h>0?a(".p_check[data-pcode='"+e+"']").addClass("hasdata"):a(".p_check[data-pcode='"+e+"']").removeClass("hasdata"),b.previewdata(b.$listdata_arr)}),h.die(),h.live("change",function(){var c=a(this).attr("data-ccode"),d=a(this).attr("data-pcode"),e=a(this).attr("data-code"),f=a(this).attr("data-name"),g=a(this),h=a(".a_check[data-ccode='"+c+"']").length,i=a(".a_check[data-ccode='"+c+"']:checked").length;if(a(".c_check[data-ccode='"+c+"']").attr("checked",h==i?!0:!1),a(".p_check[data-pcode='"+d+"']").attr("checked",1==b.getcitycheck(d)?!0:!1),g.is(":checked")?b.operate_a_data(d,c,e,f,1):b.operate_a_data(d,c,e,f,2),i>0)a(".c_check[data-ccode='"+c+"']").addClass("hasdata"),a(".p_check[data-pcode='"+d+"']").addClass("hasdata");else{a(".c_check[data-ccode='"+c+"']").removeClass("hasdata");var j=a(".c_check.hasdata[data-pcode='"+d+"']").length;0>=j&&a(".p_check[data-pcode='"+d+"']").removeClass("hasdata")}b.previewdata(b.$listdata_arr)}),a.isFunction(b.options.backdatainfo)&&(b.$confirmbtn.die(),b.$confirmbtn.live("click",function(){return b.$listdata_arr.length>0?(b.options.backdatainfo(c,b.$listdata_arr),void b.hide()):(alert("请选择门店/员工/二维码"),!1)}))}};var e=a.fn[b];a.fn[b]=function(c){return this.each(function(){var e=a(this),f=e.data("selectPlugsData"),g=a.fn[b].pluginData[f],h="object"==typeof c&&c;g||(f=a.fn[b].pluginData.index++,a.fn[b].pluginData[f]=new d(this,h),e.data("selectPlugsData",f),g=a.fn[b].pluginData[f]),g.show().bindEvent()})},a.fn[b].pluginData={index:0},a.fn[b].Constructor=b,a.fn[b].noConflict=function(){return a.fn[b]=e,this},a(document).ready(function(){a('[data-plug="'+b+'"]').each(function(){var c=a(this),d=this.dataset;a.fn[b].call(c,d)})}),d.version="1.0.0"}($);